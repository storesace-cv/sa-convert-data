#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

PYTHON_BIN="${PYTHON_BIN:-python3}"
VENV_DIR="${VENV_DIR:-.venv}"
REQ_FILE="${REQ_FILE:-requirements.txt}"

if ! command -v "$PYTHON_BIN" >/dev/null 2>&1; then
  echo "❌ Python not found (expected '$PYTHON_BIN')." >&2
  exit 1
fi

echo "▶ Ensuring virtual environment at $VENV_DIR"
if [ ! -d "$VENV_DIR" ]; then
  "$PYTHON_BIN" -m venv "$VENV_DIR"
fi

VENV_ABS="$(cd "$VENV_DIR" && pwd)"

if [ "${VIRTUAL_ENV:-}" != "$VENV_ABS" ]; then
  echo "▶ Activating virtual environment..."
  # shellcheck source=/dev/null
  source "$VENV_ABS/bin/activate"
else
  echo "▶ Virtual environment already active."
fi

python -m pip install --upgrade pip setuptools wheel

if [ -f "$REQ_FILE" ]; then
  echo "▶ Installing requirements from $REQ_FILE..."
  python -m pip install -r "$REQ_FILE"
else
  echo "⚠️  Requirements file '$REQ_FILE' not found. Skipping dependency installation."
fi

echo "▶ Launching GUI..."
exec python -m main
